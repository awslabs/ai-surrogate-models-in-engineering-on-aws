#!/bin/bash

###############################################################################
#
# Description:
#   This script creates a ZIP archive of the source code for the mlsimkit
#   Python package from a provided source distribution (sdist.tar.gz) file.
#   The resulting ZIP archive is used for distribution. The root folder is 
#   removes the version and is named 'mlsimkit/'.
#
# Usage:
#   ./make_release_src_zip <sdist.tar.gz> <output_folder>
#
#   <sdist.tar.gz>   : The path to the source distribution (sdist.tar.gz) file
#                      generated by setuptools or build system.
#   <output_folder>  : The path to the folder where the ZIP archive should be
#                      created.
#
# Workflow:
#   1. Extract the source distribution (.tar.gz) file to a temporary directory.
#   2. Move the extracted directory to a new directory named "mlsimkit".
#   3. Remove any unwanted files or directories (e.g., .gitlab*).
#   4. Create a ZIP archive containing the "mlsimkit" directory.
#   5. Place the ZIP archive in the specified output folder.
#   6. Clean up the temporary directory.
#
# Notes:
#   - This script assumes that the source distribution file follows the naming
#     convention of "mlsimkit-<version>.sdist.tar.gz".
#   - The ZIP archive will be named "mlsimkit-<version>.zip".
#
###############################################################################

# Check if two arguments are provided
if [ "$#" -ne 2 ]; then
    echo "Error: Incorrect number of arguments provided. Usage: $0 <sdist.tar.gz> <output_folder>"
    exit 1
fi

# Get the script directory (relative path)
script_dir=$(dirname "$0")

# Get the current working directory (absolute path)
cwd=$(pwd)

# Set the output directory as an absolute path
output_dir="$cwd/$2"

# Create the output directory if it doesn't exist
mkdir -p "$output_dir"

# Create a temporary directory
temp_dir=$(mktemp -d)

# Use the provided sdist.tar.gz file
tar_file="$1"

echo "Using .tar.gz file: $tar_file"

# Extract the version from the file name
version=${tar_file##*/}
version=${version%.tar.gz}
version=${version#mlsimkit-}

echo "Version: $version"

# Extract the tar.gz file to the temporary directory
tar zxf "$tar_file" -C "$temp_dir" || { rm -rf "$temp_dir"; exit 2; }

# Get the name of the extracted directory
extracted_dir=$(ls -d "$temp_dir"/mlsimkit-*)

# Check if the extracted directory exists
if [ -z "$extracted_dir" ]; then
    echo "Error: Unable to find the extracted directory (expected mlsimkit-*)"
    rm -rf "$temp_dir"
    exit 3
fi

# Move the extracted directory to a new directory named "mlsimkit"
mv "$extracted_dir" "$temp_dir/mlsimkit" || { rm -rf "$temp_dir"; exit 4; }

# Remove unwanted files, ideally this happens during setuptools but
# couldn't get it and setuptools_scm and pyproject.toml to work
rm -rf "$temp_dir/mlsimkit/.gitlab*"

# Create the zip archive
output_file="$output_dir/mlsimkit-$version-src.zip"
cd "$temp_dir" && zip --quiet -r "$output_file" mlsimkit || { cd "$cwd"; rm -rf "$temp_dir"; exit 5; }

echo "Successfully build: $output_file"

# Change back to the current working directory
cd "$cwd" || exit 6

# Clean up the temporary directory
rm -rf "$temp_dir"
